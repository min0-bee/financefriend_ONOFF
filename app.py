import streamlit as st
from datetime import datetime

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”§ (1) ë‚´ë¶€ ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸°
# í”„ë¡œì íŠ¸ ë‚´ë¶€ì— ì •ì˜ëœ ê¸°ëŠ¥ë“¤ì„ import í•©ë‹ˆë‹¤.
# core/ â†’ ê³µí†µ ì„¤ì •, ì„¸ì…˜ ê´€ë¦¬, ë¡œê¹…
# data/ â†’ ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘
# rag/  â†’ ê¸ˆìœµ ìš©ì–´ RAG(ì§€ì‹ë² ì´ìŠ¤)
# ui/   â†’ í™”ë©´ êµ¬ì„± ë° ë””ìì¸ ìš”ì†Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from core.config import USE_OPENAI
from core.user import init_session_and_user
from core.logger import log_event
from core.utils import load_logs_as_df

from data.news import collect_news
from rag.glossary import ensure_financial_terms

from ui.styles import inject_styles
from ui.components import (
    render_summary,
    render_news_list,
    render_article_detail,
    render_chatbot,
    render_sidebar,
    show_log_viewer,
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§± (2) í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Streamlit ì•±ì˜ ì œëª©, ë ˆì´ì•„ì›ƒ ë“±ì„ ì„¤ì •í•©ë‹ˆë‹¤.
st.set_page_config(
    layout="wide",              # í™”ë©´ì„ ë„“ê²Œ ì‚¬ìš©
    page_title="ê¸ˆìœµ ë‰´ìŠ¤ ë„ìš°ë¯¸"  # ë¸Œë¼ìš°ì € íƒ­ ì œëª©
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸª„ (3) ì„¸ì…˜ / ìœ ì € ì •ë³´ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¸ì…˜ ìƒíƒœ(st.session_state)ëŠ” Streamlitì´ ìœ ì €ë³„ë¡œ ìœ ì§€í•˜ëŠ” ì„ì‹œ ì €ì¥ì†Œì…ë‹ˆë‹¤.
# ì—¬ê¸°ì„œ ìœ ì €ë¥¼ ì‹ë³„í•˜ê³  í•„ìš”í•œ ê¸°ë³¸ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤.
init_session_and_user()  # ì„¸ì…˜ ID, ìœ ì € ID ë“± ìƒì„±

# ê¸ˆìœµ ìš©ì–´ ì‚¬ì „(RAGìš© ë°ì´í„°) ë³´ì¥
# ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ì„ ì„¸íŒ…í•©ë‹ˆë‹¤.
ensure_financial_terms()

# CSS ë“± ê³µí†µ ìŠ¤íƒ€ì¼ ì ìš©
inject_styles()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸªµ (4) ì„¸ì…˜ ì‹œì‘ ë¡œê·¸ (ìµœì´ˆ 1íšŒ ê¸°ë¡)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ ì €ê°€ í˜ì´ì§€ë¥¼ ì²˜ìŒ ì—´ì—ˆì„ ë•Œ 'session_start' ì´ë²¤íŠ¸ë¥¼ CSVë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
if "session_logged" not in st.session_state:
    log_event(
        "session_start",          # ì´ë²¤íŠ¸ ì¢…ë¥˜
        surface="home",           # ì–´ëŠ í™”ë©´ì—ì„œ ë°œìƒí–ˆëŠ”ì§€
        payload={
            "ua": st.session_state.get("_browser", {}),  # ë¸Œë¼ìš°ì € ì •ë³´
            "note": "MVP session start"                  # ë¶€ê°€ ì„¤ëª…
        },
    )
    st.session_state.session_logged = True  # ì¤‘ë³µ ê¸°ë¡ ë°©ì§€ìš© í”Œë˜ê·¸

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ—ï¸ (5) ë‰´ìŠ¤ ë°ì´í„° ì¤€ë¹„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ì„¸ì…˜ì— ìºì‹œí•©ë‹ˆë‹¤. (í•œ ë²ˆ ë¶ˆëŸ¬ì˜¤ë©´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ)
if "news_articles" not in st.session_state:
    st.session_state.news_articles = []

# ë‰´ìŠ¤ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ìˆ˜ì§‘ ì‹¤í–‰
if not st.session_state.news_articles:
    with st.spinner("ìµœì‹  ë‰´ìŠ¤ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘..."):  # ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        st.session_state.news_articles = collect_news()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ’¬ (6) ì„¸ì…˜ ìƒíƒœ: ì„ íƒ ê¸°ì‚¬ ë° ì±—ë´‡ ëŒ€í™” ê¸°ë¡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.session_state.setdefault("selected_article", None)  # ì„ íƒëœ ê¸°ì‚¬ (ì—†ìœ¼ë©´ None)
st.session_state.setdefault("chat_history", [])        # ì±—ë´‡ ëŒ€í™” ë¡œê·¸

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§© (7) ë©”ì¸ ë ˆì´ì•„ì›ƒ êµ¬ì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í™”ë©´ì„ ë‘ ì»¬ëŸ¼ìœ¼ë¡œ ë¶„í• :
# ì™¼ìª½(ë‰´ìŠ¤ ì˜ì—­): 2ë°° ë„“ìŒ / ì˜¤ë¥¸ìª½(ì±—ë´‡ ì˜ì—­): 1ë°° ë„“ìŒ
col1, col2 = st.columns([2, 1])

# ì™¼ìª½ ì˜ì—­: ë‰´ìŠ¤
with col1:
    st.title("ğŸ“° ê¸ˆìœµ ë‰´ìŠ¤ ë„ìš°ë¯¸")  # í˜ì´ì§€ ìƒë‹¨ ì œëª©

    # (A) ì•„ì§ ì‚¬ìš©ìê°€ ê¸°ì‚¬ë¥¼ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°
    #  â†’ ë‰´ìŠ¤ ìš”ì•½ + ê¸°ì‚¬ ëª©ë¡ì„ í‘œì‹œ
    if st.session_state.selected_article is None:
        render_summary(st.session_state.news_articles, use_openai=USE_OPENAI)
        render_news_list(st.session_state.news_articles)

    # (B) ì‚¬ìš©ìê°€ íŠ¹ì • ê¸°ì‚¬ë¥¼ í´ë¦­í•œ ê²½ìš°
    #  â†’ ê¸°ì‚¬ ë³¸ë¬¸ + í•˜ì´ë¼ì´íŠ¸ëœ ìš©ì–´ + ì„¤ëª… ë²„íŠ¼ í‘œì‹œ
    else:
        render_article_detail()

# ì˜¤ë¥¸ìª½ ì˜ì—­: ì±—ë´‡ UI
with col2:
    render_chatbot(use_openai=USE_OPENAI)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§­ (8) ì‚¬ì´ë“œë°” & ë¡œê·¸ ë·°ì–´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°”ì—ëŠ” ì„¤ì •, ë„ì›€ë§, ë²„ì „ ì •ë³´ ë“±ì„ í‘œì‹œ
render_sidebar()

# í•˜ë‹¨ êµ¬ë¶„ì„ 
st.markdown("---")

# ìˆ˜ì§‘ëœ ë¡œê·¸ ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ë³´ì—¬ì£¼ëŠ” ì˜ì—­
show_log_viewer()

