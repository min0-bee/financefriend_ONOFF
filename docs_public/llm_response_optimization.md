# LLM 응답 생성 시간 최적화 가이드

## 현재 상황 분석

### 성능 병목 지점
- **LLM 응답 생성**: 전체 응답 시간의 **95.3%** 차지
- 총 응답 시간: 6654ms 중 6340.93ms가 LLM 응답 생성에 소요
- RAG 검색: 0.02ms (거의 무시 가능)

### 현재 설정
- 모델: `gpt-4o-mini`
- max_tokens: 400-500
- temperature: 0.3
- Few-shot 예제: 7개 (매우 많음)
- 시스템 프롬프트: 매우 상세함 (약 80줄)

## 최적화 방법

### 1. Few-shot 예제 축소 (우선순위: 높음) ⭐⭐⭐

**현재 문제:**
- 7개의 Few-shot 예제가 매 요청마다 전송됨
- 각 예제가 평균 100-200 토큰 → 총 700-1400 토큰 추가
- 입력 토큰이 많을수록 처리 시간 증가

**개선 방안:**
- 7개 → 3-4개로 축소
- 가장 대표적인 예제만 유지
- 예상 효과: **20-30% 시간 단축**

**구현:**
```python
# 기존: 7개 예제
_FEWSHOT_GENERAL: List[Dict[str, str]] = [예제1, 예제2, ..., 예제7]

# 개선: 3-4개 예제만 유지
_FEWSHOT_COMPACT: List[Dict[str, str]] = [예제1, 예제2, 예제3]
```

### 2. max_tokens 감소 (우선순위: 높음) ⭐⭐⭐

**현재 설정:**
- 일반 질문: 500 토큰
- 구조화된 질문: 400 토큰

**개선 방안:**
- 일반 질문: 500 → 350 토큰
- 구조화된 질문: 400 → 300 토큰
- 예상 효과: **15-25% 시간 단축**

**주의사항:**
- 응답 품질 저하 가능성 있음
- 사용자 피드백을 받아 조정 필요

### 3. 프롬프트 최적화 (우선순위: 중간) ⭐⭐

**현재 문제:**
- 시스템 프롬프트가 매우 상세함 (약 80줄)
- 매 요청마다 전체 프롬프트 전송

**개선 방안:**
- 핵심 지침만 유지
- 중복 설명 제거
- 예상 효과: **10-15% 시간 단축**

### 4. LLM 응답 캐싱 강화 (우선순위: 중간) ⭐⭐

**현재 상태:**
- 기본 캐싱만 구현됨
- TTL이 짧을 수 있음

**개선 방안:**
- TTL 증가 (1시간 → 24시간)
- 캐시 키 범위 확대 (더 많은 쿼리 캐싱)
- 예상 효과: **반복 질문에 대해 90%+ 시간 단축**

### 5. 스트리밍 우선 사용 (우선순위: 중간) ⭐⭐

**현재 상태:**
- 스트리밍 구현되어 있지만 fallback이 많음

**개선 방안:**
- 스트리밍을 기본으로 사용
- 실패 시에만 일반 모드로 fallback
- 예상 효과: **체감 시간 30-50% 개선** (실제 시간은 동일하지만 사용자 경험 개선)

### 6. 모델 변경 고려 (우선순위: 낮음) ⭐

**옵션:**
- `gpt-4o-mini` → `gpt-3.5-turbo` (더 빠르지만 품질 저하)
- `gpt-4o-mini` → `gpt-4o` (더 느리지만 품질 향상)

**권장:**
- 현재 모델 유지 (품질과 속도의 균형)

## 구현 우선순위

### 즉시 적용 (높은 효과, 낮은 리스크)
1. ✅ **Few-shot 예제 축소** (7개 → 3-4개)
2. ✅ **max_tokens 감소** (500 → 350, 400 → 300)

### 단기 적용 (중간 효과, 중간 리스크)
3. **프롬프트 최적화** (핵심만 유지)
4. **캐싱 강화** (TTL 증가, 범위 확대)

### 장기 검토 (낮은 효과 또는 높은 리스크)
5. **스트리밍 우선 사용** (이미 구현됨)
6. **모델 변경** (품질 저하 가능)

## 예상 효과

### 최적화 전
- LLM 응답 생성: **6340ms** (95.3%)

### 최적화 후 (Few-shot 축소 + max_tokens 감소)
- Few-shot 축소: 6340ms → **4438ms** (30% 감소)
- max_tokens 감소: 4438ms → **3327ms** (25% 감소)
- **총 예상 시간: 3327ms** (약 50% 개선)

### 추가 최적화 (프롬프트 최적화 + 캐싱)
- 프롬프트 최적화: 3327ms → **2994ms** (10% 감소)
- 캐싱 강화: 반복 질문에 대해 **<100ms** (90%+ 감소)

## 주의사항

1. **품질 유지**: 최적화 시 응답 품질이 저하되지 않도록 주의
2. **사용자 피드백**: 변경 후 사용자 피드백을 받아 조정
3. **점진적 적용**: 한 번에 모든 최적화를 적용하지 말고 단계적으로 적용
4. **성능 모니터링**: 최적화 후 성능 지표를 지속적으로 모니터링

