# êµ¬ì¡°ì  ë¬¸ì œ ë¶„ì„: ìµœì í™” íŒŒì¼ì˜ ì„±ëŠ¥ ì €í•˜ ì›ì¸

## ğŸ” ë°œê²¬ëœ êµ¬ì¡°ì  ë¬¸ì œë“¤

### 1. **í† í° ì¶”ì • ì˜¤ë²„í—¤ë“œ (CPU ì‹œê°„ ì†Œëª¨)**

**ë¬¸ì œ ì½”ë“œ** (`persona_optimized.py:181`):
```python
_log_prompt_stats(messages, mdl, logger)  # ë§¤ë²ˆ í˜¸ì¶œ
```

**ë‚´ë¶€ ë™ì‘** (`persona_optimized.py:132-144`):
```python
def _estimate_token_count(messages: List[Dict[str, str]], model: str) -> int:
    # tiktokenìœ¼ë¡œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì¸ì½”ë”©
    enc = tiktoken.encoding_for_model(model)
    total = 0
    for message in messages:
        for value in message.values():
            if isinstance(value, str):
                total += len(enc.encode(value))  # âš ï¸ CPU ì§‘ì•½ì  ì—°ì‚°
    return total
```

**ì˜í–¥**:
- ë§¤ API í˜¸ì¶œë§ˆë‹¤ ì „ì²´ ë©”ì‹œì§€ë¥¼ tiktokenìœ¼ë¡œ ì¸ì½”ë”©
- ì•½ 5-10msì˜ CPU ì‹œê°„ ì†Œëª¨ (ë©”ì‹œì§€ ê¸¸ì´ì— ë¹„ë¡€)
- ì›ë³¸ì—ëŠ” ì—†ëŠ” ì¶”ê°€ ì˜¤ë²„í—¤ë“œ

**í•´ê²°ì±…**: 
- loggerê°€ Noneì´ë©´ ìŠ¤í‚µí•˜ì§€ë§Œ, `_log_prompt_stats` ë‚´ë¶€ì—ì„œ í•­ìƒ `_estimate_token_count` í˜¸ì¶œ
- ì‹¤ì œë¡œëŠ” loggerê°€ ì—†ì–´ë„ í˜¸ì¶œë˜ì§€ ì•Šì§€ë§Œ, ì½”ë“œ êµ¬ì¡°ìƒ í˜¼ë€ìŠ¤ëŸ¬ì›€

### 2. **ë¶ˆí•„ìš”í•œ ë”•ì…”ë„ˆë¦¬ ì—°ì‚°**

**ë¬¸ì œ ì½”ë“œ** (`persona_optimized.py:218, 227`):
```python
# stream=Falseì¼ ë•Œë„ pop í˜¸ì¶œ
api_params.pop("stream")  # âš ï¸ ë¶ˆí•„ìš”í•œ ì—°ì‚°

# ë©”íƒ€ë°ì´í„° ìƒì„± ì‹œ ë”•ì…”ë„ˆë¦¬ ì»´í”„ë¦¬í—¨ì…˜
"api_params": {k: v for k, v in api_params.items() if k != "messages"}
```

**ì˜í–¥**:
- ë¯¸ë¯¸í•˜ì§€ë§Œ ë¶ˆí•„ìš”í•œ CPU ì‚¬ì´í´ ì†Œëª¨
- ì½”ë“œ ê°€ë…ì„± ì €í•˜

### 3. **íŒŒì¼ I/O ë¡œê¹… ì˜¤ë²„í—¤ë“œ**

**ë¬¸ì œ ì½”ë“œ** (`persona_optimized.py:246-253`):
```python
PERSONA_LOGGER.info(
    "latency=%ss | input=%s | output=%s | total=%s | model=%s",
    log_payload["latency"],
    log_payload["input_tokens"],
    log_payload["output_tokens"],
    log_payload["total_tokens"],
    log_payload["model"],
)
```

**ì˜í–¥**:
- ë§¤ API í˜¸ì¶œë§ˆë‹¤ íŒŒì¼ì— ë¡œê·¸ ê¸°ë¡
- íŒŒì¼ I/OëŠ” ë¸”ë¡œí‚¹ ì—°ì‚° (ì•½ 1-5ms)
- ì›ë³¸ì—ëŠ” ì—†ëŠ” ì¶”ê°€ ì˜¤ë²„í—¤ë“œ

**ë¹„êµ**:
- ì›ë³¸: ë¡œê¹… ì—†ìŒ â†’ ì¦‰ì‹œ ë°˜í™˜
- ìµœì í™”: ë¡œê¹… ì¶”ê°€ â†’ íŒŒì¼ ì“°ê¸° í›„ ë°˜í™˜

### 4. **ë©”ì‹œì§€ êµ¬ì¡° ë³µì¡ë„ ì¦ê°€**

**ì›ë³¸** (`persona.py:384`):
```python
return [sys, dev, usr]  # 3ê°œ ë©”ì‹œì§€
```

**ìµœì í™”** (`persona_optimized.py:290`):
```python
return [sys, dev, *_FEWSHOT_COMPACT, usr]  # 5ê°œ ë©”ì‹œì§€
```

**ì˜í–¥**:
- ë©”ì‹œì§€ ìˆ˜ ì¦ê°€: 3ê°œ â†’ 5ê°œ
- OpenAI APIê°€ ë” ë§ì€ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•´ì•¼ í•¨
- Few-shot ì˜ˆì œ 2ê°œ ì¶”ê°€ë¡œ ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ì¦ê°€

**ì‹¤ì œ ì²˜ë¦¬ ì‹œê°„**:
- ë©”ì‹œì§€ê°€ ë§ì„ìˆ˜ë¡ ëª¨ë¸ì´ ë” ë§ì€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬
- Few-shotì´ ìˆìœ¼ë©´ ëª¨ë¸ì´ ì˜ˆì œë¥¼ ì°¸ê³ í•˜ì§€ë§Œ, ì²˜ë¦¬ ì‹œê°„ì€ ì¦ê°€í•  ìˆ˜ ìˆìŒ

### 5. **ì‹œìŠ¤í…œ ë©”ì‹œì§€ 2ê°œ êµ¬ì¡°**

**ì›ë³¸ê³¼ ìµœì í™” ëª¨ë‘**:
```python
sys = {"role": "system", "content": base_prompt}
dev = {"role": "system", "content": "[í–‰ë™ ê·œì¹™] ..."}
```

**ì˜í–¥**:
- ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ 2ê°œë¡œ ë¶„ë¦¬ë˜ì–´ ìˆìŒ
- í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ
- í•˜ì§€ë§Œ ì´ê±´ ì›ë³¸ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìµœì í™” íŒŒì¼ì˜ ë¬¸ì œëŠ” ì•„ë‹˜

### 6. **ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ë¡œì§ì˜ ë¹„íš¨ìœ¨**

**ë¬¸ì œ ì½”ë“œ** (`persona_optimized.py:202-216`):
```python
if stream:
    api_params.pop("stream")  # âš ï¸ pop í›„ ì‚¬ìš©
    with client.chat.completions.stream(**api_params) as stream_resp:
        # ...
else:
    api_params.pop("stream")  # âš ï¸ stream=Falseì¼ ë•Œë„ pop
    resp = client.chat.completions.create(**api_params)
```

**ë¬¸ì œì **:
- `api_params`ì— `stream`ì„ ë„£ì—ˆë‹¤ê°€ ë°”ë¡œ ë¹¼ëŠ” ë¹„íš¨ìœ¨
- stream=Falseì¼ ë•ŒëŠ” ì•„ì˜ˆ ë„£ì§€ ì•ŠëŠ” ê²Œ ë‚˜ìŒ

**ê°œì„ ì•ˆ**:
```python
api_params = {
    "model": mdl,
    "messages": messages,
    "temperature": temperature,
    "max_tokens": max_tokens,
}
if stream:
    with client.chat.completions.stream(**api_params, stream=True) as stream_resp:
        # ...
else:
    resp = client.chat.completions.create(**api_params)
```

## ğŸ“Š ì„±ëŠ¥ ì˜í–¥ ìš”ì•½

| ë¬¸ì œ | ì˜ˆìƒ ì§€ì—° | ë¹ˆë„ | ëˆ„ì  ì˜í–¥ |
|------|----------|------|----------|
| í† í° ì¶”ì • (tiktoken) | 5-10ms | ë§¤ í˜¸ì¶œ | âš ï¸ ì¤‘ê°„ |
| íŒŒì¼ ë¡œê¹… (I/O) | 1-5ms | ë§¤ í˜¸ì¶œ | âš ï¸ ì¤‘ê°„ |
| ë©”ì‹œì§€ ìˆ˜ ì¦ê°€ (Few-shot) | 10-50ms | ë§¤ í˜¸ì¶œ | âš ï¸âš ï¸ ë†’ìŒ |
| ë¶ˆí•„ìš”í•œ ë”•ì…”ë„ˆë¦¬ ì—°ì‚° | <1ms | ë§¤ í˜¸ì¶œ | âœ… ë‚®ìŒ |
| ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ë¹„íš¨ìœ¨ | <1ms | ë§¤ í˜¸ì¶œ | âœ… ë‚®ìŒ |

**ì´ ì˜ˆìƒ ì¶”ê°€ ì§€ì—°**: ì•½ 16-65ms (ì²´ê°í•˜ê¸° ì–´ë ¤ìš´ ìˆ˜ì¤€ì´ì§€ë§Œ ëˆ„ì ë˜ë©´ ë¬¸ì œ)

## ğŸ¯ í•µì‹¬ ë¬¸ì œ: Few-shot ì¶”ê°€

**ê°€ì¥ í° ë¬¸ì œëŠ” Few-shot ì˜ˆì œ ì¶”ê°€**ì…ë‹ˆë‹¤:

1. **ë©”ì‹œì§€ ìˆ˜ ì¦ê°€**: 3ê°œ â†’ 5ê°œ
2. **í† í° ìˆ˜ ì¦ê°€**: ì•½ 250 í† í° ì¶”ê°€
3. **ëª¨ë¸ ì²˜ë¦¬ ì‹œê°„ ì¦ê°€**: ë” ë§ì€ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬ í•„ìš”

**ì›ë³¸ì˜ ì˜ë„**:
- Few-shot ì—†ì´ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë§Œìœ¼ë¡œ ì¶©ë¶„íˆ ë™ì‘í•˜ë„ë¡ ì„¤ê³„
- ìµœì†Œí•œì˜ ë©”ì‹œì§€ë¡œ ë¹ ë¥¸ ì‘ë‹µ

**ìµœì í™” íŒŒì¼ì˜ ë¬¸ì œ**:
- "ìµœì í™”"ë¼ê³  í•˜ë©´ì„œ ì˜¤íˆë ¤ Few-shotì„ ì¶”ê°€í•´ ë³µì¡ë„ ì¦ê°€
- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì¤„ì˜€ì§€ë§Œ Few-shotìœ¼ë¡œ ìƒì‡„

## ğŸ’¡ í•´ê²° ë°©ì•ˆ

### ì¦‰ì‹œ ì ìš© ê°€ëŠ¥:

1. **Few-shot ì œê±°** (ê°€ì¥ ì¤‘ìš”)
   ```python
   return [sys, dev, usr]  # Few-shot ì œê±°
   ```

2. **ë¡œê¹…ì„ ë¹„ë™ê¸°ë¡œ ë³€ê²½** ë˜ëŠ” **ì¡°ê±´ë¶€ ë¡œê¹…**
   ```python
   if ENABLE_LOGGING:  # í™˜ê²½ ë³€ìˆ˜ë¡œ ì œì–´
       PERSONA_LOGGER.info(...)
   ```

3. **í† í° ì¶”ì • ìµœì í™”**
   ```python
   # loggerê°€ Noneì´ë©´ ì•„ì˜ˆ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
   if logger:
       _log_prompt_stats(messages, mdl, logger)
   ```

4. **ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ê°œì„ **
   ```python
   # stream íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ê±´ë¶€ë¡œ ì¶”ê°€
   ```

### ì¥ê¸°ì  ê°œì„ :

1. **ì‹œìŠ¤í…œ ë©”ì‹œì§€ í†µí•©**: sys + devë¥¼ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
2. **ìºì‹±**: ë™ì¼í•œ í”„ë¡¬í”„íŠ¸ ì¬ì‚¬ìš©
3. **ë¹„ë™ê¸° ë¡œê¹…**: íŒŒì¼ I/Oë¥¼ ë°±ê·¸ë¼ìš´ë“œë¡œ ì²˜ë¦¬

## ğŸ”¬ ì‹¤í—˜ì  ê²€ì¦ í•„ìš”

ë‹¤ìŒê³¼ ê°™ì€ ë²¤ì¹˜ë§ˆí¬ê°€ í•„ìš”í•©ë‹ˆë‹¤:

1. **Few-shot ìœ ë¬´ ë¹„êµ**
   - Few-shot ìˆìŒ vs ì—†ìŒ
   - ì‹¤ì œ ì‘ë‹µ ì‹œê°„ ì¸¡ì •

2. **ë¡œê¹… ì˜¤ë²„í—¤ë“œ ì¸¡ì •**
   - ë¡œê¹… ìˆìŒ vs ì—†ìŒ
   - íŒŒì¼ I/O ì‹œê°„ ì¸¡ì •

3. **í† í° ì¶”ì • ì˜¤ë²„í—¤ë“œ ì¸¡ì •**
   - tiktoken ì¸ì½”ë”© ì‹œê°„ ì¸¡ì •

## ğŸ“ ê²°ë¡ 

**êµ¬ì¡°ì  ë¬¸ì œ ìš”ì•½**:

1. âœ… **API í˜¸ì¶œì€ 1íšŒë§Œ** - ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•˜ëŠ” ë¬¸ì œëŠ” ì—†ìŒ
2. âš ï¸ **Few-shot ì¶”ê°€ë¡œ ë©”ì‹œì§€ ë³µì¡ë„ ì¦ê°€** - ê°€ì¥ í° ë¬¸ì œ
3. âš ï¸ **ë¡œê¹… ì˜¤ë²„í—¤ë“œ** - íŒŒì¼ I/Oë¡œ ì¸í•œ ì§€ì—°
4. âš ï¸ **í† í° ì¶”ì • ì˜¤ë²„í—¤ë“œ** - CPU ì‹œê°„ ì†Œëª¨
5. âœ… **ë¶ˆí•„ìš”í•œ ì—°ì‚°ë“¤** - ë¯¸ë¯¸í•˜ì§€ë§Œ ê°œì„  ê°€ëŠ¥

**ì²´ê°ì´ ì•ˆ ë˜ëŠ” ì´ìœ **:
- Few-shot ì¶”ê°€ë¡œ ì‹¤ì œë¡œëŠ” ë” ëŠë ¤ì§ˆ ìˆ˜ ìˆìŒ
- ë¡œê¹…ê³¼ í† í° ì¶”ì •ìœ¼ë¡œ ì¶”ê°€ ì§€ì—° ë°œìƒ
- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì ˆê° íš¨ê³¼ê°€ Few-shot ì¶”ê°€ë¡œ ìƒì‡„

**ì¦‰ì‹œ ê°œì„  ê°€ëŠ¥**:
- Few-shot ì œê±° â†’ ê°€ì¥ í° íš¨ê³¼
- ë¡œê¹… ì¡°ê±´ë¶€ ì²˜ë¦¬ â†’ íŒŒì¼ I/O ì œê±°
- í† í° ì¶”ì • ìµœì í™” â†’ CPU ì‹œê°„ ì ˆê°



