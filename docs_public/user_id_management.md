# 사용자 ID 생성·관리 방식 안내

본 문서는 2025-11에 적용된 사용자 ID 생성 로직 변경 사항을 정리합니다.  
배포 환경에서 여러 사용자가 접속할 때 `user_id`가 동일하게 기록되던 문제를 해소하고, 브라우저별로 고유 식별자가 유지되도록 구성했습니다.

---

## 변경 배경
- 기존 로직은 `logs/user_info.json`(서버 공용 디스크)을 우선 참조했습니다.
- 배포 서버는 모든 사용자가 동일한 파일 시스템을 공유하므로, 최초 접속자가 남긴 `user_id`가 이후 사용자에게도 복사되어 **모든 이벤트 로그가 같은 ID**로 기록되는 문제가 있었습니다.

## 개선 사항 요약
- `core/user.py`에서 `streamlit_js_eval`을 사용해 **브라우저 `localStorage`(`ff_user_id`)**를 우선 조회하도록 변경했습니다.
- `get_or_create_user_id()` 동작 순서:
  1. URL 쿼리 파라미터 `?uid=`가 존재하면 해당 값을 사용하고 동기화.
  2. 브라우저 `localStorage`에 저장된 `ff_user_id`가 있으면 그대로 사용.
  3. 둘 다 없으면 새로운 UUID를 생성해 `localStorage`, `logs/user_info.json`, URL 파라미터에 동기화.
- `core/logger._save_server_user_id()` 또한 서버에서 받은 UUID를 위 3곳에 다시 저장해 브라우저와 서버가 동일한 식별자를 공유하도록 합니다.

## 브라우저 단위 동작
- **각 브라우저/프로필/디바이스**는 서로 다른 `localStorage`를 사용하므로, 접속마다 고유 `user_id`가 부여됩니다.
- 동일 브라우저에서 페이지를 새로고침하거나 재방문해도 기존 `ff_user_id`가 유지됩니다.
- 브라우저 데이터를 삭제하거나 시크릿/프라이빗 창을 사용하면 새 UUID가 생성됩니다.
- 서버가 사용자 생성을 완료하면 반환한 `backend_user_id` 역시 `localStorage`에 저장되므로, 이후 모든 이벤트가 서버 UUID로 집계됩니다.

## 로그/시각화 영향
- Supabase 및 로그 뷰어에서 `user_id` 기준 통계가 정확히 분리됩니다.
- 세션 추정기(`session_id_resolved`)가 사용자 단위로 정상 작동하여 세션 지속시간/전환 그래프가 의미 있는 분포를 보여줍니다.

## 확인 방법
1. 배포된 앱에 서로 다른 브라우저(또는 시크릿 창)로 접속합니다.
2. 개발자 도구 콘솔에서 `localStorage.getItem('ff_user_id')`를 실행하면 브라우저마다 다른 UUID가 확인됩니다.
3. Supabase event log 또는 로그 뷰어의 “사용자 활동 요약”에서 사용자별 레코드가 분리된 것을 확인할 수 있습니다.

## FAQ
- **문: 왜 여전히 동일한 `user_id`가 보이나요?**  
  → 이전 버전에서 이미 수집된 로그는 그대로 남아 있습니다. 새로운 접속 이후 생성된 이벤트를 기준으로 확인해 주세요.

- **문: localStorage를 사용할 수 없는 환경에서는?**  
  → 로컬 파일 `logs/user_info.json`과 URL 파라미터에 동일 값을 기록해두기 때문에, 최소한 브라우저 세션 내에서는 ID가 유지됩니다.  
  다만 kiosk 등 특수 환경에서는 브라우저 설정이 초기화될 수 있으므로, 필요 시 별도의 로그인/식별 수단을 고려해야 합니다.

---

추가 질문이나 개선 요청이 있으면 `core/user.py`와 `core/logger.py` 관련 이슈에 댓글을 남겨 주세요.

