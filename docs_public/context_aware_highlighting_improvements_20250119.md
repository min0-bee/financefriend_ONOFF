# 문맥 인식 하이라이트 개선 작업 (2025-01-19)

## 📋 작업 개요

뉴스 기사에서 금융 용어를 하이라이트할 때, 브랜드명이나 일반 단어로 사용된 경우에도 하이라이트되는 문제를 해결하기 위해 문맥 인식 로직을 개선했습니다.

## 🐛 발견된 문제

### 문제 사례
1. **"대상 종가"** - "종가"가 브랜드명으로 사용되었지만 하이라이트됨
2. **"aT는... 수출국에서..."** - "종가"가 하이라이트됨 (문맥상 브랜드명)
3. **"대상 "종가" 김치는... 국가에 진출"** - "종가"가 하이라이트됨 (문맥상 브랜드명)

### 원인 분석
- "수출", "국가" 같은 일반 단어가 경제 키워드로 오인식됨
- "대상 종가" 패턴을 특별 처리하지 않음
- 부정 키워드 체크 로직이 약함
- 문맥 윈도우가 너무 넓어서 (100자) 관련 없는 키워드까지 포함됨

## ✅ 개선 사항

### 1. 문맥 윈도우 크기 축소
- **변경 전**: 100자 (앞뒤 각 50자)
- **변경 후**: 50자 (앞뒤 각 25자)
- **효과**: 더 빠른 처리 속도, 더 정확한 문맥 판단

```python
# rag/glossary.py
def is_financial_context(..., window_size: int = 50):  # 100 → 50으로 변경
```

### 2. 부정 키워드 목록 추가
브랜드명, 회사명, 일반 단어를 식별하기 위한 부정 키워드 목록을 추가했습니다.

```python
# rag/glossary.py
NEGATIVE_KEYWORDS = [
    '브랜드', '회사', '기업명', '상표', '제품명', '씨', '님', '사장', '대표',
    '김치', '수출', '수입', '제조', '생산', '판매', '마케팅', '광고',
    '대상', '종가', '삼성', 'LG', '현대', '기아', 'SK', '롯데', '신세계'
]
```

### 3. "대상 종가" 패턴 특별 처리
"대상 종가" 또는 "종가 대상" 패턴이 문맥에 있으면 무조건 브랜드명으로 판단하도록 특별 처리했습니다.

```python
# rag/glossary.py - is_financial_context 함수 내
# ⚠️ 특별 패턴 체크: "대상 종가" 같은 브랜드명 패턴
if term.lower() == '종가':
    # "대상 종가" 또는 "종가" 앞뒤에 "대상"이 있는지 확인
    target_pattern = r'\b대상\s*종가\b|\b종가\s*대상\b'
    if re.search(target_pattern, context_lower, re.IGNORECASE):
        return False  # 브랜드명으로 판단
```

### 4. 부정 키워드 체크 로직 개선
부정 키워드가 발견되면, 강한 경제 키워드가 있는지 확인하여 최종 판단합니다.

```python
# rag/glossary.py
# 브랜드/회사명 관련 부정 키워드만 체크 (더 엄격)
brand_negative_keywords = ['대상', '종가', '삼성', 'LG', '현대', '기아', 'SK', '롯데', '신세계', '브랜드', '회사', '기업명', '상표', '제품명', '김치', '수출', '수입']

# 부정 키워드가 발견된 경우
if found_negative_keyword:
    # 강한 경제 키워드가 있는지 확인 (부정 키워드보다 우선순위가 높음)
    strong_financial_keywords = ['코스피', '코스닥', '주가', '장', '마감', '거래', '가격', '지수', '시장', '투자', '금융', '경제', '상승', '하락', '변동', '매매', '체결', '호가']
    has_financial_keyword = False
    for fin_keyword in strong_financial_keywords:
        fin_pattern = r'\b' + re.escape(fin_keyword.lower()) + r'\b'
        if re.search(fin_pattern, context_lower):
            has_financial_keyword = True
            break
    
    # 부정 키워드가 있고 명확한 경제 키워드가 없으면 False
    # 단, "수출", "국가" 같은 일반 단어는 경제 키워드로 인정하지 않음
    if not has_financial_keyword:
        return False
```

### 5. 단어 경계를 고려한 정확한 매칭
정규식의 `\b` (단어 경계)를 사용하여 더 정확한 키워드 매칭을 구현했습니다.

```python
# rag/glossary.py
# 단어 경계를 고려한 매칭 (더 정확함)
neg_pattern = r'\b' + re.escape(neg_keyword.lower()) + r'\b'
if re.search(neg_pattern, context_lower):
    # 부정 키워드 발견
```

### 6. 강한 경제 키워드만 인정
"수출", "국가" 같은 일반 단어는 경제 키워드로 인정하지 않고, 명확한 금융/경제 용어만 인정하도록 개선했습니다.

**강한 경제 키워드 목록:**
- `코스피`, `코스닥`, `주가`, `장`, `마감`, `거래`, `가격`, `지수`
- `시장`, `투자`, `금융`, `경제`, `상승`, `하락`, `변동`
- `매매`, `체결`, `호가`

## 📊 개선 효과

### 예상 효과
1. **정확도 향상**: 브랜드명으로 사용된 "종가"가 하이라이트되지 않음
2. **처리 속도 개선**: 문맥 윈도우 축소로 더 빠른 처리
3. **오탐지 감소**: 일반 단어가 경제 키워드로 오인식되는 경우 감소

### 테스트 케이스

#### ✅ 하이라이트 안 되어야 함 (브랜드명)
- "대상 종가" → 하이라이트 안 됨
- "aT는... 수출국에서..." → "종가" 하이라이트 안 됨
- "대상 "종가" 김치는... 국가에 진출" → "종가" 하이라이트 안 됨

#### ✅ 하이라이트 되어야 함 (경제 용어)
- "종가 기준 코스피" → "종가" 하이라이트 됨
- "오늘 종가가 상승했다" → "종가" 하이라이트 됨
- "장 마감 시점의 종가" → "종가" 하이라이트 됨

## 🔧 수정된 파일

### `rag/glossary.py`
1. **문맥 윈도우 크기**: `window_size` 기본값 100 → 50
2. **부정 키워드 목록 추가**: `NEGATIVE_KEYWORDS` 상수 추가
3. **특별 패턴 체크**: "대상 종가" 패턴 특별 처리
4. **부정 키워드 체크 로직 개선**: 강한 경제 키워드 확인 후 판단
5. **단어 경계 고려**: 정규식 `\b` 사용

## 📝 참고 사항

### 향후 개선 가능 사항
1. **동적 부정 키워드 학습**: 사용자 피드백을 통해 부정 키워드 목록 확장
2. **문맥 윈도우 동적 조정**: 용어별로 최적의 윈도우 크기 설정
3. **머신러닝 기반 문맥 판단**: 더 정교한 문맥 인식 모델 도입

### 주의 사항
- 부정 키워드 목록은 지속적으로 업데이트가 필요합니다.
- 새로운 브랜드명이나 회사명이 추가되면 부정 키워드 목록에 추가해야 합니다.
- "수출", "국가" 같은 일반 단어는 경제 키워드로 인정하지 않지만, 실제 경제 기사에서는 문맥에 따라 다를 수 있습니다.

## 🎯 결론

문맥 인식 하이라이트 기능을 개선하여 브랜드명이나 일반 단어로 사용된 경우를 더 정확하게 식별할 수 있게 되었습니다. 특히 "대상 종가" 같은 특정 패턴을 특별 처리하여 오탐지를 크게 줄였습니다.

