# 응답시간 분석 스크립트 사용 가이드

## 개요

`persona_timing_analysis.py`는 원본과 최적화 버전의 응답시간을 단계별로 측정하여 병목 지점을 파악하는 도구입니다.

## 측정 항목

### 원본 버전
- 프롬프트 빌드 시간
- API 호출 시간
- 응답 파싱 시간
- 출력 포맷팅 시간

### 최적화 버전
- 프롬프트 빌드 시간
- 토큰 추정 시간 (추가)
- 로깅 오버헤드 (추가)
- API 호출 시간
- 응답 파싱 시간
- 출력 포맷팅 시간

## 사용 방법

### 기본 사용법

```bash
python experiments/persona_timing_analysis.py --prompt "인플레이션이 뭐야?"
```

### 옵션

- `--prompt`: 분석할 사용자 질문 (필수)
- `--term`: 선택적 용어 (예: "인플레이션")
- `--runs`: 실행 횟수 (기본값: 10)
- `--output`: 결과를 저장할 JSON 파일 경로
- `--quiet`: 상세 리포트 출력 생략

### 예제

```bash
# 기본 분석
python experiments/persona_timing_analysis.py --prompt "금리가 오르면 주식이 왜 떨어져?"

# 용어 포함 분석
python experiments/persona_timing_analysis.py --prompt "금리가 오르면 주식이 왜 떨어져?" --term "금리"

# 더 많은 실행으로 정확도 향상
python experiments/persona_timing_analysis.py --prompt "인플레이션이 뭐야?" --runs 20

# 결과를 파일로 저장
python experiments/persona_timing_analysis.py --prompt "GDP가 뭐야?" --output results.json
```

## 출력 예시

```
================================================================================
📊 상세 응답시간 분석 결과
================================================================================

질문: 인플레이션이 뭐야?
실행 횟수: 10회

================================================================================
⏱️  전체 응답 시간 비교
================================================================================

원본 버전:
  평균: 1.234초
  최소: 1.123초 | 최대: 1.456초
  표준편차: 0.089초

최적화 버전:
  평균: 1.345초
  최소: 1.234초 | 최대: 1.567초
  표준편차: 0.098초

⚡ 성능 변화: -9.0% (1.234초 → 1.345초)

================================================================================
🔍 단계별 시간 분석
================================================================================

단계                  원본 (평균)     최적화 (평균)   차이            
--------------------------------------------------------------------------------
프롬프트 빌드           0.001초         0.002초         +0.001초 (+100.0%)
API 호출               1.200초         1.300초         +0.100초 (+8.3%)
응답 파싱               0.020초         0.020초         +0.000초 (+0.0%)
출력 포맷팅             0.013초         0.013초         +0.000초 (+0.0%)

최적화 버전 전용 단계:
--------------------------------------------------------------------------------
  토큰 추정: 0.005초 (평균)
  로깅 오버헤드: 0.002초 (평균)

================================================================================
📨 메시지 구조 비교
================================================================================

원본: 평균 3.0개 메시지
최적화: 평균 5.0개 메시지
차이: +2.0개

================================================================================
🔢 토큰 사용량 (최적화 버전)
================================================================================

추정 입력 토큰: 평균 480개
실제 입력 토큰: 평균 485개
실제 출력 토큰: 평균 120개
총 토큰: 평균 605개
```

## 결과 해석

### 성능 변화
- **양수**: 최적화 버전이 더 빠름
- **음수**: 최적화 버전이 더 느림

### 단계별 분석
각 단계의 시간을 비교하여 병목 지점을 파악할 수 있습니다:
- **API 호출**: 가장 큰 시간 소모 (네트워크 + 모델 처리)
- **프롬프트 빌드**: 일반적으로 매우 빠름 (<1ms)
- **파싱/포맷팅**: 일반적으로 빠름 (<20ms)

### 메시지 수 비교
- 메시지가 많을수록 모델이 더 많은 컨텍스트를 처리해야 함
- Few-shot 예제 추가로 메시지 수가 증가할 수 있음

### 토큰 사용량
- 입력 토큰이 많을수록 API 호출 비용 증가
- 출력 토큰이 많을수록 생성 시간 증가

## JSON 출력 형식

```json
{
  "prompt": "인플레이션이 뭐야?",
  "term": null,
  "runs": 10,
  "original": {
    "timings": {
      "total": {"mean": 1.234, "min": 1.123, "max": 1.456, "stdev": 0.089},
      "build_messages": {"mean": 0.001, ...},
      "api_call": {"mean": 1.200, ...},
      ...
    },
    "message_count": {"mean": 3.0, ...}
  },
  "optimized": {
    "timings": {...},
    "message_count": {...},
    "token_estimate": {...},
    ...
  },
  "raw_original": [...],
  "raw_optimized": [...]
}
```

## 주의사항

1. **API 비용**: 각 실행마다 실제 API 호출이 발생하므로 비용이 발생합니다.
2. **네트워크 지연**: 네트워크 상태에 따라 결과가 달라질 수 있습니다.
3. **실행 시간**: `--runs` 값이 클수록 더 정확하지만 시간이 오래 걸립니다.

## 기존 벤치마크와의 차이

- **기존 벤치마크** (`persona_benchmark.py`): 전체 응답 시간만 측정
- **상세 분석** (`persona_timing_analysis.py`): 각 단계별 시간을 측정하여 병목 지점 파악

## 문제 해결

### Import 오류
```bash
# 프로젝트 루트에서 실행
cd /path/to/min0_persona
python experiments/persona_timing_analysis.py --prompt "테스트"
```

### API 키 오류
환경 변수나 `core.config`에 OpenAI API 키가 설정되어 있는지 확인하세요.

